# ğŸš€ TypeScript Backend Docker Compose
version: '3.8'

services:
  # NestJS Backend
  ts-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recipe-ai-ts-backend
    ports:
      - "8081:8081"  # REST API
      - "8083:8083"  # WebSocket
    environment:
      # ì„œë²„ ì„¤ì •
      NODE_ENV: production
      PORT: 8081
      WEBSOCKET_PORT: 8083
      
      # ë°ì´í„°ë² ì´ìŠ¤ (NAS IPë¡œ ìˆ˜ì • í•„ìš”)
      MONGODB_URI: mongodb://recipe_admin:RecipeDB_2024_Secure%239x7!@192.168.0.111:27017/recipe_ai_db
      ELASTICSEARCH_URL: http://192.168.0.111:9200
      REDIS_URL: redis://:RecipeAI2024!@192.168.0.111:6379
      
      # AI ì„œë¹„ìŠ¤ (NASì—ì„œ Ollama ì‹¤í–‰ ì‹œ)
      OLLAMA_URL: http://192.168.0.111:11434
      OLLAMA_MODEL: gemma2:2b
      
      # ë³´ì•ˆ
      JWT_SECRET: recipe-ai-ultra-secure-key-2024!@#$
      JWT_EXPIRES_IN: 7d
    
    volumes:
      # ë¡œê·¸ ì €ì¥ (NAS ê²½ë¡œë¡œ ìˆ˜ì •)
      - ./logs:/app/logs
      
    restart: unless-stopped
    
    # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
    networks:
      - recipe-ai-network
    
    # ì˜ì¡´ì„± ì²´í¬ (ì™¸ë¶€ ì„œë¹„ìŠ¤ ëŒ€ê¸°)
    depends_on:
      - wait-for-services
    
    # í—¬ìŠ¤ì²´í¬
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ì™¸ë¶€ ì„œë¹„ìŠ¤ ëŒ€ê¸°ìš©
  wait-for-services:
    image: busybox:1.35
    container_name: wait-for-services
    command: |
      sh -c "
        echo 'â³ ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘...'
        
        # MongoDB ëŒ€ê¸°
        until nc -z 192.168.0.111 27017; do
          echo 'ğŸ“Š MongoDB ì—°ê²° ëŒ€ê¸°...'
          sleep 2
        done
        echo 'âœ… MongoDB ì—°ê²° í™•ì¸'
        
        # Redis ëŒ€ê¸°  
        until nc -z 192.168.0.111 6379; do
          echo 'ğŸ”„ Redis ì—°ê²° ëŒ€ê¸°...'
          sleep 2
        done
        echo 'âœ… Redis ì—°ê²° í™•ì¸'
        
        # Elasticsearch ëŒ€ê¸°
        until nc -z 192.168.0.111 9200; do
          echo 'ğŸ” Elasticsearch ì—°ê²° ëŒ€ê¸°...'
          sleep 2
        done
        echo 'âœ… Elasticsearch ì—°ê²° í™•ì¸'
        
        echo 'ğŸš€ ëª¨ë“  ì„œë¹„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ!'
      "
    networks:
      - recipe-ai-network

networks:
  recipe-ai-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

# Docker Compose ì‚¬ìš©ë²•:
# docker-compose up -d          # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
# docker-compose logs -f        # ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
# docker-compose down           # ì¢…ë£Œ
# docker-compose restart        # ì¬ì‹œì‘
